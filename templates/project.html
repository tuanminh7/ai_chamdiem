{% extends "layout.html" %}
{% block title %}{{ project.title }}{% endblock %}
{% block content %}
<h2> {{ project.title }}</h2>
<p>{{ project.description }}</p>

{% if feedback %}
  <div class="feedback"><strong>{{ feedback }}</strong></div>
{% endif %}

<h3> Gửi bài làm</h3>
<form method="POST" enctype="multipart/form-data">
  <input type="text" name="group_name" placeholder="Tên nhóm" required>
  <input type="file" name="image" accept=".png,.jpg,.jpeg,.pdf" required>
  <textarea name="note" placeholder="Ghi chú về bài làm (nếu có)" rows="4" style="width:100%; margin-top:10px;"></textarea>
  <button type="submit">Gửi bài</button>
</form>

<hr>
<h3> Bài làm đã gửi</h3>
{% for img in images %}
  <div style="margin-bottom: 30px;">
    <p><strong>Nhóm:</strong> {{ img.group_name }}</p>
    {% if img.note %}
      <p><strong>Ghi chú:</strong> {{ img.note }}</p>
    {% endif %}

    {% if img.file_type == 'pdf' %}
      <p> <a href="{{ url_for('static', filename='uploads/' ~ img.filename) }}" target="_blank">Xem file PDF</a></p>
    {% else %}
      <img src="{{ url_for('static', filename='uploads/' ~ img.filename) }}" width="300"><br><br>
    {% endif %}

    <p><strong>Phản hồi AI:</strong><br>{{ img.ai_feedback }}</p>

    {% if img.score_feedback %}
      <p><strong> Đánh giá điểm:</strong><br>{{ img.score_feedback }}</p>
    {% endif %}

    <h4>💬 Bình luận & Chấm điểm</h4>
    <form method="POST" action="{{ url_for('comment', project_id=project.id, image_id=img.id) }}">
      <input type="text" name="student_name" placeholder="Tên học sinh" required>
      <input type="text" name="comment_text" placeholder="Bình luận" required>
      <input type="number" name="score" placeholder="Điểm (0-10)" min="0" max="10" step="0.1" required>
      <button type="submit">Gửi</button>
    </form>

    <p><strong>📊 Điểm trung bình:</strong> 
       {{ img.average_score if img.average_score else "Chưa có" }}
    </p>

    <ul>
      {% for cmt in img.comments %}
        <li>
          <strong>{{ cmt.student_name }}:</strong> {{ cmt.comment_text }}
          {% if cmt.score is defined %} (Điểm: {{ cmt.score }}){% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
  <hr>
{% endfor %}
<a href="/projects">⬅️ Quay lại danh sách đề bài</a>
{% endblock %}
